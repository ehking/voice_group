<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>دورهمی آنالایزر</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <style>body{font-family:'Vazirmatn',sans-serif;}</style>
</head>
<body class="bg-gray-50">
<div class="max-w-5xl mx-auto py-10 px-4" x-data="jobDashboard()" x-init="loadJobs()">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-semibold">دورهمی آنالایزر</h1>
      <p class="text-sm text-gray-600">آپلود فایل و شروع پردازش</p>
    </div>
  </div>
  <div class="bg-white rounded shadow p-6 mb-6">
    <form id="uploadForm" @submit.prevent="submitForm" class="space-y-4" enctype="multipart/form-data">
      <div>
        <label class="block text-sm mb-1">فایل صوتی</label>
        <input type="file" name="file" required class="w-full border rounded px-3 py-2" />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">نوع فایل</label>
          <select name="file_type" class="w-full border rounded px-3 py-2">
            <option>جلسه خودمونی</option>
            <option>کافه</option>
            <option>مهمونی</option>
            <option>جلسه تیمی</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">سطح نویز</label>
          <select name="noise_level" class="w-full border rounded px-3 py-2">
            <option>کم</option>
            <option selected>متوسط</option>
            <option>زیاد</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">حداکثر نفرات</label>
          <input type="number" name="max_speakers" min="2" max="10" value="4" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm mb-1">حساسیت تشخیص قطع کردن حرف</label>
          <select name="interruption_sensitivity" class="w-full border rounded px-3 py-2">
            <option value="low">کم</option>
            <option value="med" selected>متوسط</option>
            <option value="high">زیاد</option>
          </select>
        </div>
      </div>
      <div class="flex items-center space-x-4 space-x-reverse">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">شروع</button>
        <div x-show="uploading" class="text-sm text-gray-600">در حال آپلود...</div>
      </div>
      <div class="w-full bg-gray-200 rounded h-2" x-show="progress>0">
        <div class="bg-blue-600 h-2 rounded" :style="`width:${progress}%`"></div>
      </div>
    </form>
  </div>
  <div class="bg-white rounded shadow p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">کارها</h2>
      <button @click="loadJobs" class="text-sm text-blue-600">به‌روزرسانی</button>
    </div>
    <div class="space-y-3" x-show="jobs.length">
      <template x-for="job in jobs" :key="job.id">
        <div class="border rounded px-4 py-3 flex items-center justify-between">
          <div>
            <div class="font-semibold" x-text="job.file_name || job.id"></div>
            <div class="text-sm text-gray-600" x-text="`وضعیت: ${job.status}`"></div>
          </div>
          <div class="flex items-center space-x-3 space-x-reverse">
            <div class="w-32 bg-gray-200 h-2 rounded">
              <div class="bg-green-500 h-2 rounded" :style="`width:${job.progress}%`"></div>
            </div>
            <a :href="`/jobs/${job.id}`" class="text-blue-600 text-sm">مشاهده</a>
          </div>
        </div>
      </template>
    </div>
    <div x-show="!jobs.length" class="text-gray-500 text-sm">هنوز کاری ثبت نشده است.</div>
  </div>
</div>
<script>
function jobDashboard(){
  return {
    jobs:[], uploading:false, progress:0,
    async submitForm(){
      const form=document.getElementById('uploadForm');
      const data=new FormData(form);
      this.uploading=true; this.progress=10;
      const res=await fetch('/api/jobs',{method:'POST',body:data});
      if(!res.ok){alert('خطا در آپلود'); this.uploading=false; return;}
      this.progress=100; this.uploading=false; form.reset();
      const json=await res.json();
      window.location=`/jobs/${json.job_id}`;
    },
    async loadJobs(){
      const res=await fetch('/api/jobs');
      this.jobs=await res.json();
    }
  }
}
</script>
</body>
</html>
